# Claude Code Project Helper

This document provides instructions and context for Claude Code to effectively assist with development in this repository.

## Project Overview

- **Project Name:** Elegoo Printer Home Assistant Integration
- **Type:** Home Assistant Custom Component
- **Language:** Python
- **Primary Code Location:** `custom_components/elegoo_printer/`

## Development Environment

This project uses `uv` for Python environment and dependency management. The virtual environment is expected to be located at `.venv/`.

- **Setup:** To set up the development environment and install all dependencies (including dev dependencies), run:
  ```bash
  make setup
  ```

## Key Commands

The `Makefile` contains all the necessary commands for common development tasks.

- **Linting:** To check the code for style and quality issues, run:

  ```bash
  make lint
  ```

- **Formatting:** To automatically format the code, run:

  ```bash
  make format
  ```

- **Fixing:** To automatically fix linting issues, run:

  ```bash
  make fix
  ```

- **Testing:** To run the automated test suite, run:

  ```bash
  make test
  ```

- **Running the development server:** To start the Home Assistant instance with the custom component for development, run:

  ```bash
  make start
  ```

- **Running the debug server:** To start the Home Assistant instance in debug mode, run:
  ```bash
  make debug
  ```

## Committing and Contributions

- Before committing any changes, please ensure that the code passes both the linter and the test suite.
- Run `make fix` and `make test` to validate your changes.
- Follow the existing code style and conventions.
- **Always create a feature branch for new work. Do not commit directly to `main`**

## Releases and Versioning

This project uses automated releases via GitHub Actions.

### Version Management

Version numbers must be updated in **both** files:
- `custom_components/elegoo_printer/manifest.json` - The `version` field
- `pyproject.toml` - The `version` field in the `[project]` section

**Important:** Both versions must match exactly, or the release workflow will fail validation.

### Creating a Release

1. Update version in both `manifest.json` and `pyproject.toml`
2. Commit and push to `main` branch
3. GitHub Actions automatically:
   - Validates version consistency
   - Runs linting (`make lint`)
   - Runs tests (`make test`)
   - Creates git tag (e.g., `v2.7.0`)
   - Generates release notes from commits/PRs
   - Publishes GitHub release

### Version Format

Follow semantic versioning: `MAJOR.MINOR.PATCH[-PRERELEASE]`

**Stable releases:**
- `2.7.0` - New features
- `2.7.1` - Bug fixes
- `3.0.0` - Breaking changes

**Pre-releases:**
- `2.8.0-alpha.1` - Alpha version (early testing)
- `2.8.0-beta.1` - Beta version (feature complete, needs testing)
- `2.8.0-rc.1` - Release candidate (ready for release, final testing)

Pre-release versions are automatically detected (by the `-` suffix) and marked as "Pre-release" on GitHub.

### Release Workflow Details

The automated release workflow (`.github/workflows/release.yml`):
- **Triggers:** When `manifest.json` is modified on `main` branch
- **Validates:** Version consistency between manifest.json and pyproject.toml
- **Tests:** Runs full linting and test suite
- **Prevents:** Duplicate releases if tag already exists
- **Generates:** Release notes automatically using GitHub's API

### Manual Release Override

If you need to manually create a release:
```bash
gh release create v2.7.0 --title "v2.7.0" --generate-notes
```

For pre-releases:
```bash
gh release create v2.8.0-beta.1 --title "v2.8.0-beta.1" --generate-notes --prerelease
```

## Logging

The Home Assistant logs are located at `config/home-assistant.log`.

## Repository Structure

Here's a breakdown of the key files and directories in this repository and their general purpose:

- Project Root (/):

  - .devcontainer.json: Configuration for development containers (e.g., VS Code Dev Containers).
  - .gitattributes, .gitignore: Git configuration for file handling and ignored files.
  - .python-version: Specifies the Python version for tools like pyenv.
  - CONTRIBUTING.md: Guidelines for project contributions.
  - debug.py: A script used for debugging the Home Assistant integration.
  - CLAUDE.md: This document, providing context and instructions for Claude Code.
  - hacs.json: Configuration file for Home Assistant Community Store (HACS) integration.
  - LICENSE: The project's open-source license.
  - Makefile: Commands for common development tasks (setup, linting, formatting, testing, running the dev server).
  - pyproject.toml: Project metadata, dependencies, and tool configurations (e.g., uv, ruff, pytest).
  - README.md: The main project documentation and overview.
  - uv.lock: A lock file generated by uv to ensure reproducible Python environments.

- .github/: GitHub-specific configurations.

  - ISSUE_TEMPLATE/: Templates for creating new issues on GitHub.
  - workflows/: GitHub Actions workflows for continuous integration (CI) tasks like linting, testing, and releases.

- .venv/: The Python virtual environment where project dependencies are installed.

- blueprints/: Home Assistant automation blueprints.

  - automation/elegoo_printer/elegoo_printer_progress.yaml: A blueprint related to printer progress.

- config/: A Home Assistant configuration directory used for local development and testing.

  - configuration.yaml: The main Home Assistant configuration file for the development instance.

- custom_components/elegoo_printer/: Core directory for the custom component.

  - `__init__.py`: Initializes the Python package and the Home Assistant integration itself.
  - api.py
  - button.py, camera.py, fan.py, image.py, light.py, number.py, select.py, sensor.py
  - config_flow.py
  - const.py
  - coordinator.py
  - manifest.json
  - sdcp/: SDCP protocol implementation and models.
    - models/: Data models (e.g., printer status, print history).
    - exceptions.py, const.py (as applicable)
  - websocket/: WebSocket client/server implementation.
    - client.py
    - server.py
  - translations/en.json: English translations for the integration UI.

- scripts/: Utility scripts for development.

- tests/: Unit and integration tests for the project.